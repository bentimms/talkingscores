<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
    <title>Talking score for {{ basic_information['title'] }}</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="robots" content="noindex" />
    
    <!-- midi.js package -->
    <script type='text/javascript' src='//www.midijs.net/lib/midi.js'></script> 
{#   <!-- extras -->#}
    <style type="text/css">
        body{font-family: Georgia; font-size: 16pt}
    </style>
</head>
<body>

<h1>Info</h1>

<p>{{ basic_information['title']|default('Untitled work') }} by {{ basic_information['composer']|default('Unknown composer') }}.</p>

<p>Time signature of {{ preamble['time_signature'] }}, key signature of {{ preamble['key_signature'] }}, tempo of {{ preamble['tempo']|default('no tempo specified') }}</p>
<p>Music, both hands, a bar at a time, beat by beat</p>

<h2>Entire score:</h2>
{% if play_all %}
    <a href="#" onClick="MIDIjs.play('{{ full_score_midis.midi_all + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play All Instruments </a>
    <br/>
{% endif %}
{% if play_selected %}
    <a href="#" onClick="MIDIjs.play('{{ full_score_midis.midi_sel + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play Selected Instruments </a>
    <br/>
{% endif %}
{% if play_unselected %}
    <a href="#" onClick="MIDIjs.play('{{ full_score_midis.midi_un + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play Unselected Instruments</a>
    <br/>
{% endif %}
<br/>
<b>Instrument MIDIs</b><br/>
{% for index, ins in full_score_midis.selected_instruments_midis.items() %}
    <a href="#" onClick="MIDIjs.play('{{ ins.midi + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play - {{instruments[ins.ins][0]}} </a><br/>
    <li style="margin-left:15px; list-style-type:none;">
        {% for midipart in ins.midi_parts %}
            <a href="#" onClick="MIDIjs.play('{{ midipart + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">{{part_names[instruments[ins.ins][1] + loop.index-1 ]}}  </a><br/>
        {% endfor %}
    </li>
{% endfor %}
<br/>

<h2>Stop Music Playback</h2>
<a href="#" onClick="MIDIjs.stop(); return false;">Stop playback</a>

{% for segment in music_segments %}

    <h2>Bar{% if segment.start_bar != segment.end_bar %}s{% endif %} {{ segment.start_bar }} {% if segment.start_bar != segment.end_bar %} to {{ segment.end_bar }}{% endif %}</h2>
    {% if play_all %}
        <a href="#" onClick="MIDIjs.play('{{ segment.midi_all + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play All - bar{% if segment.start_bar != segment.end_bar %}s{% endif %} {{ segment.start_bar }} {% if segment.start_bar != segment.end_bar %} to {{ segment.end_bar }}{% endif %} </a>
        <br/>
    {% endif %}
    {% if play_selected %}
        <a href="#" onClick="MIDIjs.play('{{ segment.midi_sel + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play Selected - bar{% if segment.start_bar != segment.end_bar %}s{% endif %} {{ segment.start_bar }} {% if segment.start_bar != segment.end_bar %} to {{ segment.end_bar }}{% endif %} </a>
        <br/>
    {% endif %}
    {% if play_unselected %}
        <a href="#" onClick="MIDIjs.play('{{ segment.midi_un + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play Unselected - bar{% if segment.start_bar != segment.end_bar %}s{% endif %} {{ segment.start_bar }} {% if segment.start_bar != segment.end_bar %} to {{ segment.end_bar }}{% endif %} </a>
        <br/>
    {% endif %}
    <br/>
    <b>Instrument MIDIs</b><br/>
    {% for index, ins in segment.selected_instruments_midis.items() %}
        <a href="#" onClick="MIDIjs.play('{{ ins.midi + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">Play - {{instruments[ins.ins][0]}} - bar{% if segment.start_bar != segment.end_bar %}s{% endif %} {{ segment.start_bar }} {% if segment.start_bar != segment.end_bar %} to {{ segment.end_bar }}{% endif %} </a><br/>
        <li style="margin-left:15px; list-style-type:none;">
            {% for midipart in ins.midi_parts %}
                <a href="#" onClick="MIDIjs.play('{{ midipart + "&bsi="}}{{binary_selected_instruments}}{{"&bpi="}}{{binary_play_all}}'); return false;">{{part_names[instruments[ins.ins][1] + loop.index-1 ]}}  </a><br/>
            {% endfor %}
        </li>
    {% endfor %}
    <br/>

    {#  Loop over each bar pulling out the beat-based dictionaries #}
    {% for bar, events_for_beats in segment.events_by_bar_and_beat|dictsort %}
        {% if not loop.first %}<br/><br/>{% endif %}
        <h3>Bar: {{ bar }}</h3>

        {#  Loop over each beat pulling out the hand-based dictionaries #}
        {% for beat, events_per_hand in events_for_beats.items() %}
            {# {% if not loop.first %}<br/>{% endif %}#}
            <div>Beat {{ beat | int  }}:
            {#  Loop over each hand #}
            {% for hand in ('Both', 'Left', 'Right', 'BothAfter') %}
                {#  Create a dict to store the previous value (a plain variable has problems with scope) #}
                {% set previous_event = {'value' : None} %}
                {#  Loop over each hand #}
                {# Are there are events in this hand? #}
                {% if hand in events_per_hand.keys() %}
                    <div>
                    {# Yes, only output the name of the hand if it's not Both or BothAfter #}
                    {% if hand not in ('Both', 'BothAfter') %}{{ hand }} hand:{% endif %}
                    {#  Pull out the event arrays for each pitch index #}
                    {% for voice, events_per_voice in events_per_hand[hand]|dictsort|reverse %}
                        {% if not loop.first %} together with {% endif %}
                        {% for pitch_space, events in events_per_voice.items() %}
                            {% if not loop.first %}, {% endif %}
                            {#  Loop over the events  #}
                            {% for event in events %}
                                {{ event.render(previous_event['value'])|join(' ') }}
                                {#  Store the event for context next time around  #}
                                {% set _ = previous_event.update({'value': event}) %}
                            {% endfor %} {# End loop over events #}
                        {% endfor %} {# End loop over pitch indexes #}
                    {% endfor %}. {# End loop over voices #}
                    </div>
                {% endif %} {# End test for existence of hand-specific dictionary #}
            {% endfor %} {# End loop over hands indexes #}
            </div>
        {% endfor %} {# End loop over beats #}
     {% endfor %} {# End loop over bars #}

{% endfor %}


{#<script type="text/javascript">#}
{##}
{#    window.onload = function () {#}
{#        MIDI.loadPlugin({#}
{#            soundfontUrl: "../lib/MIDI.js/soundfont/",#}
{#            instrument: "acoustic_grand_piano",#}
{#            callback: function () {#}
{#                var delay = 0; // play one note every quarter second#}
{#                var note = 50; // the MIDI note#}
{#                var velocity = 127; // how hard the note hits#}
{#                // play the note#}
{#                MIDI.setVolume(0, 127);#}
{#                MIDI.noteOn(0, note, velocity, delay);#}
{#                MIDI.noteOff(0, note, delay + 0.75);#}
{#            }#}
{#        });#}
{#    };#}
{##}
{#</script>#}
</body>
</html>